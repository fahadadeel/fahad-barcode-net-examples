name: Auto-Generate Documentation (Node.js)
on:
  push:
    paths:
      - 'Examples.Core/**/*.cs'
    branches:
      - main
      - develop
  pull_request:
    paths:
      - 'Examples.Core/**/*.cs'
    types: [opened, synchronize]

env:
  LITELLM_API_KEY: ${{ secrets.LITELLM_API_KEY }}
  GITHUB_GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
  DOCUMENTATION_REPO: ${{ secrets.DOCUMENTATION_REPO }}
  DOCUMENTATION_TOKEN: ${{ secrets.DOCUMENTATION_REPO_TOKEN }}
  DOCUMENTATION_TARGET_BRANCH: ${{ secrets.DOCUMENTATION_TARGET_BRANCH }}

jobs:
  detect-new-examples:
    runs-on: ubuntu-latest
    outputs:
      examples: ${{ steps.detect.outputs.examples }}
      has_new_examples: ${{ steps.detect.outputs.has_new_examples }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '.github/scripts/package.json'

      - name: Install Dependencies
        working-directory: .github/scripts
        run: npm ci

      - name: Detect New Examples
        id: detect
        working-directory: .github/scripts
        run: node detect-examples.js

  validate-examples:
    needs: detect-new-examples
    if: needs.detect-new-examples.outputs.has_new_examples == 'true'
    runs-on: ubuntu-latest
    outputs:
      validation_passed: ${{ steps.validate.outputs.validation_passed }}
      valid_examples: ${{ steps.validate.outputs.valid_examples }}
      validation_summary: ${{ steps.validate.outputs.validation_summary }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '.github/scripts/package.json'

      - name: Install Dependencies
        working-directory: .github/scripts
        run: npm ci

      - name: Validate All Examples
        id: validate
        working-directory: .github/scripts
        run: |
          EXAMPLES_LIST="${{ join(fromJson(needs.detect-new-examples.outputs.examples), ',') }}"
          echo "ÔøΩ Validating examples: $EXAMPLES_LIST"
          node validate-examples.js --example-files "$EXAMPLES_LIST"

  create-gists:
    needs: [detect-new-examples, validate-examples]
    if: needs.detect-new-examples.outputs.has_new_examples == 'true' && needs.validate-examples.outputs.validation_passed == 'true'
    runs-on: ubuntu-latest
    outputs:
      gist_data: ${{ steps.create_gists.outputs.gist_data }}
    strategy:
      matrix:
        example: ${{ fromJson(needs.validate-examples.outputs.valid_examples) }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '.github/scripts/package.json'

      - name: Install Dependencies
        working-directory: .github/scripts
        run: npm ci

      - name: Create GitHub Gists
        id: create_gists
        working-directory: .github/scripts
        run: |
          node create-gists.js \
            --example-file "${{ matrix.example }}" \
            --examples-repo ".."

      - name: Upload Gist Data
        uses: actions/upload-artifact@v4
        with:
          name: gist-data-${{ strategy.job-index }}
          path: .github/scripts/gist-*.json
          retention-days: 1

  generate-documentation:
    needs: [detect-new-examples, validate-examples, create-gists]
    if: needs.detect-new-examples.outputs.has_new_examples == 'true' && needs.validate-examples.outputs.validation_passed == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        example: ${{ fromJson(needs.validate-examples.outputs.valid_examples) }}
    steps:
      - name: Check Documentation Repository Configuration
        id: check_docs_repo
        run: |
          # Check if DOCUMENTATION_REPO is configured
          if [ -z "${{ env.DOCUMENTATION_REPO }}" ] || [ "${{ env.DOCUMENTATION_REPO }}" = "" ]; then
            echo "‚ùå DOCUMENTATION_REPO not configured. Skipping documentation generation."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # STRICT VALIDATION: DOCUMENTATION_TARGET_BRANCH must be explicitly set
          if [ -z "${{ env.DOCUMENTATION_TARGET_BRANCH }}" ] || [ "${{ env.DOCUMENTATION_TARGET_BRANCH }}" = "" ]; then
            echo "‚ùå ERROR: DOCUMENTATION_TARGET_BRANCH secret is required but not set!"
            echo ""
            echo "üîß CONFIGURATION REQUIRED:"
            echo "   Please set the DOCUMENTATION_TARGET_BRANCH secret in repository settings:"
            echo "   Repository Settings ‚Üí Secrets and Variables ‚Üí Actions ‚Üí New repository secret"
            echo ""
            echo "üìã EXAMPLE VALUES:"
            echo "   ‚Ä¢ qa                    (for QA environment)"
            echo "   ‚Ä¢ staging              (for staging environment)"  
            echo "   ‚Ä¢ docs-review          (for documentation review)"
            echo "   ‚Ä¢ dev                  (for development)"
            echo ""
            echo "‚ö†Ô∏è  SECURITY NOTE:"
            echo "   This workflow requires explicit target branch configuration to prevent"
            echo "   accidental deployment to production branches like 'main' or 'master'."
            echo ""
            echo "‚ùå Workflow execution stopped. Please configure the required secret."
            exit 1
          fi
          
          echo "‚úÖ DOCUMENTATION_TARGET_BRANCH explicitly set to: ${{ env.DOCUMENTATION_TARGET_BRANCH }}"
          
          # Extract repo name from URL if it's a full GitHub URL
          REPO_NAME="${{ env.DOCUMENTATION_REPO }}"
          if [[ "$REPO_NAME" == https://github.com/* ]]; then
            REPO_NAME=$(echo "$REPO_NAME" | sed 's|https://github.com/||')
          fi
          echo "‚úÖ DOCUMENTATION_REPO configured: $REPO_NAME"
          echo "üéØ Target branch: ${{ env.DOCUMENTATION_TARGET_BRANCH }}"
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT

      - name: Checkout Examples Repo
        if: steps.check_docs_repo.outputs.skip == 'false'
        uses: actions/checkout@v4
        with:
          path: examples-repo

      - name: Checkout Documentation Repo
        if: steps.check_docs_repo.outputs.skip == 'false'
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.check_docs_repo.outputs.repo_name }}
          token: ${{ env.DOCUMENTATION_TOKEN }}
          path: docs-repo

      - name: Validate Target Branch
        if: steps.check_docs_repo.outputs.skip == 'false'
        working-directory: docs-repo
        run: |
          TARGET_BRANCH="${{ env.DOCUMENTATION_TARGET_BRANCH }}"
          echo "üîç Checking if target branch '$TARGET_BRANCH' exists..."
          
          # Get current branch info
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "üìç Currently on branch: $CURRENT_BRANCH"
          
          # Check if branch exists locally
          if git show-ref --verify --quiet refs/heads/$TARGET_BRANCH; then
            echo "‚úÖ Target branch '$TARGET_BRANCH' exists locally"
            # Just switch to it if not already on it
            if [ "$CURRENT_BRANCH" != "$TARGET_BRANCH" ]; then
              git checkout $TARGET_BRANCH
              echo "üîÑ Switched to existing local branch '$TARGET_BRANCH'"
            fi
          else
            # Check if branch exists remotely
            if git ls-remote --exit-code --heads origin $TARGET_BRANCH >/dev/null 2>&1; then
              echo "üì• Target branch '$TARGET_BRANCH' exists remotely, checking it out..."
              git fetch origin $TARGET_BRANCH:$TARGET_BRANCH
              git checkout $TARGET_BRANCH
              echo "‚úÖ Checked out remote branch '$TARGET_BRANCH'"
            else
              echo "‚ö†Ô∏è Target branch '$TARGET_BRANCH' doesn't exist. Creating from current branch..."
              
              # Get the default branch name with multiple fallback methods
              DEFAULT_BRANCH=""
              
              # Method 1: Try symbolic-ref (most reliable when set up)
              if DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@'); then
                echo "üìç Default branch detected via symbolic-ref: $DEFAULT_BRANCH"
              # Method 2: Try to get from remote HEAD
              elif DEFAULT_BRANCH=$(git ls-remote --symref origin HEAD | head -1 | awk '{print $2}' | sed 's@refs/heads/@@'); then
                echo "üìç Default branch detected via ls-remote: $DEFAULT_BRANCH"
              # Method 3: Common defaults fallback
              elif git show-ref --verify --quiet refs/remotes/origin/main; then
                DEFAULT_BRANCH="main"
                echo "üìç Default branch fallback: $DEFAULT_BRANCH"
              elif git show-ref --verify --quiet refs/remotes/origin/master; then
                DEFAULT_BRANCH="master"
                echo "üìç Default branch fallback: $DEFAULT_BRANCH"
              else
                # Method 4: Use current branch as last resort
                DEFAULT_BRANCH="$CURRENT_BRANCH"
                echo "üìç Using current branch as fallback: $DEFAULT_BRANCH"
              fi
              
              # Ensure we're on the default branch
              if [ "$CURRENT_BRANCH" != "$DEFAULT_BRANCH" ]; then
                git checkout $DEFAULT_BRANCH
                echo "üîÑ Switched to default branch: $DEFAULT_BRANCH"
              fi
              
              # Create new branch from default branch
              git checkout -b $TARGET_BRANCH
              git push origin $TARGET_BRANCH
              echo "‚úÖ Created target branch '$TARGET_BRANCH' from '$DEFAULT_BRANCH'"
            fi
          fi
          
          # Verify we're on the target branch
          FINAL_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          if [ "$FINAL_BRANCH" = "$TARGET_BRANCH" ]; then
            echo "‚úÖ Successfully on target branch: $TARGET_BRANCH"
          else
            echo "‚ùå ERROR: Expected to be on '$TARGET_BRANCH' but on '$FINAL_BRANCH'"
            exit 1
          fi

      - name: Setup Node.js
        if: steps.check_docs_repo.outputs.skip == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'examples-repo/.github/scripts/package.json'

      - name: Install Dependencies
        if: steps.check_docs_repo.outputs.skip == 'false'
        working-directory: examples-repo/.github/scripts
        run: npm ci

      - name: Download Gist Data
        if: steps.check_docs_repo.outputs.skip == 'false'
        uses: actions/download-artifact@v4
        with:
          pattern: gist-data-*
          path: gist-artifacts/
          merge-multiple: true

      - name: Copy Gist Data
        if: steps.check_docs_repo.outputs.skip == 'false'
        run: |
          mkdir -p examples-repo/.github/scripts/
          cp -v gist-artifacts/*.json examples-repo/.github/scripts/ || echo "No gist files found"
          ls -la examples-repo/.github/scripts/gist-*.json || echo "No gist files after copy"

      - name: Generate Documentation
        if: steps.check_docs_repo.outputs.skip == 'false'
        working-directory: examples-repo/.github/scripts
        run: |
          node generate-docs.js \
            --example-file "${{ matrix.example }}" \
            --examples-repo "../.." \
            --docs-repo "../../../docs-repo"

      - name: Create Pull Request
        if: steps.check_docs_repo.outputs.skip == 'false'
        uses: peter-evans/create-pull-request@v5
        with:
          path: docs-repo
          token: ${{ env.DOCUMENTATION_TOKEN }}
          base: ${{ env.DOCUMENTATION_TARGET_BRANCH }}
          commit-message: 'docs: Add documentation for ${{ matrix.example }}'
          title: 'Auto-generated documentation for ${{ matrix.example }}'
          body: |
            ## Auto-generated Documentation

            This PR was automatically generated for the new example: `${{ matrix.example }}`

            ### Changes
            - Added documentation based on code analysis using AI
            - Created interactive GitHub Gist with complete example code
            - Followed existing documentation structure and patterns
            - Included code examples, Gist embeds, and proper formatting

            ### Target Branch
            This PR targets the `${{ env.DOCUMENTATION_TARGET_BRANCH }}` branch for integration.

            ### Source
            Generated from: `${{ matrix.example }}`
            Repository: `${{ github.repository }}`
            Commit: `${{ github.sha }}`

            Please review the generated content for accuracy and completeness.

            ---
            *Generated by Node.js auto-documentation system*
          branch: auto-docs/${{ matrix.example }}-${{ github.run_number }}
          delete-branch: true
